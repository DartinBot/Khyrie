<!-- FitFriendsClubs COMPLETE Wix Integration Script -->
<!-- INSTALLATION: Copy this ENTIRE file and paste into Wix Settings > Custom Code > Body - end -->
<!-- This is the ONLY file you need - includes styles, configuration, and all functionality -->

<style type="text/css">
/* FitFriendsClubs Complete Styles */
.fitfriends-loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #4CAF50;
    border-radius: 50%;
    animation: fitfriends-spin 1s linear infinite;
}

@keyframes fitfriends-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fitfriends-error {
    color: #F44336;
    background: #ffebee;
    padding: 8px 12px;
    border-radius: 4px;
    border-left: 4px solid #F44336;
    margin: 10px 0;
    font-size: 14px;
}

.fitfriends-success {
    color: #4CAF50;
    background: #e8f5e8;
    padding: 8px 12px;
    border-radius: 4px;
    border-left: 4px solid #4CAF50;
    margin: 10px 0;
    font-size: 14px;
}

.fitfriends-status-online {
    color: #4CAF50 !important;
    font-weight: bold;
}

.fitfriends-status-offline {
    color: #F44336 !important;
    font-weight: bold;
}

/* Club and Trail Cards */
.fitfriends-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 16px;
    margin: 8px 0;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.fitfriends-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.fitfriends-badge {
    display: inline-block;
    background: #2196F3;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    margin: 2px;
}

.fitfriends-difficulty-easy { 
    background: #4CAF50 !important; 
    color: white !important;
}
.fitfriends-difficulty-moderate { 
    background: #FF9800 !important; 
    color: white !important;
}
.fitfriends-difficulty-hard { 
    background: #F44336 !important; 
    color: white !important;
}

/* Loading overlay */
.fitfriends-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

/* Status indicators */
.fitfriends-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 12px;
}

.fitfriends-status.success {
    background: #e8f5e8;
    color: #4CAF50;
}

.fitfriends-status.error {
    background: #ffebee;
    color: #F44336;
}

/* Debug panel */
.fitfriends-debug {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 12px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 11px;
    z-index: 9998;
    max-width: 250px;
}

.fitfriends-debug button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    margin-top: 5px;
}
</style>

<script type="text/javascript">
(function() {
    'use strict';
    
    console.log('🏋️ FitFriendsClubs Complete Integration Loading...');
    
    // ========================================
    // CONFIGURATION SETUP
    // ========================================
    
    try {
        window.FitFriendsConfig = {
            API_URL: 'https://fitfriendsclub-api.darnellroy2.workers.dev',
            DEBUG_MODE: true,    // Set false for production
            AUTO_LOAD: true,     // Auto-load page data
            RETRY_ATTEMPTS: 3,
            TIMEOUT: 15000,
            
            FEATURES: {
                CLUBS: true,     // Enable clubs
                TRAILS: true,    // Enable trails  
                DASHBOARD: true, // Enable dashboard
                LIGHTBOXES: true // Enable popups
            }
        };
        
        console.log('✅ Configuration loaded:', window.FitFriendsConfig.API_URL);
        
    } catch (error) {
        console.error('❌ Config error:', error);
        window.FitFriendsConfig = {
            API_URL: 'https://fitfriendsclub-api.darnellroy2.workers.dev',
            DEBUG_MODE: true
        };
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    
    window.showGlobalLoading = function() {
        try {
            if ($w('#globalLoading')) $w('#globalLoading').show();
            if ($w('#loadingIcon')) $w('#loadingIcon').show();
        } catch(e) {
            console.warn('Loading elements not found');
        }
    };

    window.hideGlobalLoading = function() {
        try {
            if ($w('#globalLoading')) $w('#globalLoading').hide();
            if ($w('#loadingIcon')) $w('#loadingIcon').hide();
        } catch(e) {
            console.warn('Loading elements not found');
        }
    };

    window.showLoading = function(containerSelector) {
        try {
            if ($w('#loadingIcon')) $w('#loadingIcon').show();
            if (containerSelector && $w(containerSelector)) {
                $w(containerSelector).addClass('loading');
            }
        } catch(e) {
            console.warn('Loading error for:', containerSelector);
        }
    };

    window.hideLoading = function(containerSelector) {
        try {
            if ($w('#loadingIcon')) $w('#loadingIcon').hide();
            if (containerSelector && $w(containerSelector)) {
                $w(containerSelector).removeClass('loading');
            }
        } catch(e) {
            console.warn('Hide loading error for:', containerSelector);
        }
    };

    window.showError = function(message) {
        console.error('❌ Error:', message);
        try {
            if ($w('#errorMessage')) {
                $w('#errorMessage').text = message;
                $w('#errorMessage').addClass('fitfriends-error');
                $w('#errorMessage').show();
                setTimeout(() => {
                    if ($w('#errorMessage')) $w('#errorMessage').hide();
                }, 7000);
            }
            
            // Also try notification elements
            if ($w('#notificationBar')) {
                $w('#notificationBar').text = message;
                $w('#notificationBar').show();
                setTimeout(() => {
                    if ($w('#notificationBar')) $w('#notificationBar').hide();
                }, 5000);
            }
        } catch(e) {
            console.warn('Error display failed:', e);
        }
    };

    window.showSuccess = function(message) {
        console.log('✅ Success:', message);
        try {
            if ($w('#successMessage')) {
                $w('#successMessage').text = message;
                $w('#successMessage').addClass('fitfriends-success');
                $w('#successMessage').show();
                setTimeout(() => {
                    if ($w('#successMessage')) $w('#successMessage').hide();
                }, 4000);
            }
        } catch(e) {
            console.warn('Success display failed:', e);
        }
    };

    window.updateGlobalStatus = function(status, message) {
        const statusElements = [
            '#statusIndicator', '#globalStatus', '#apiStatus', 
            '#connectionStatus', '#systemStatus'
        ];
        
        statusElements.forEach(selector => {
            try {
                if ($w(selector)) {
                    $w(selector).text = message;
                    if (status === 'online' || status === 'success') {
                        $w(selector).addClass('fitfriends-status-online');
                        $w(selector).removeClass('fitfriends-status-offline');
                    } else {
                        $w(selector).addClass('fitfriends-status-offline');
                        $w(selector).removeClass('fitfriends-status-online');
                    }
                }
            } catch(e) {
                console.warn('Status update failed for:', selector);
            }
        });
    };

    window.updateClubCount = function(count) {
        const countElements = [
            '#clubCountDisplay', '#clubsCount', '#totalClubs', 
            '#clubCountText', '#clubCounter'
        ];
        countElements.forEach(selector => {
            try {
                if ($w(selector)) {
                    $w(selector).text = count + ' Clubs Available';
                }
            } catch(e) {
                console.warn('Club count update failed for:', selector);
            }
        });
    };

    window.updateTrailCount = function(count) {
        const countElements = [
            '#trailCountDisplay', '#trailsCount', '#totalTrails', 
            '#trailCountText', '#trailCounter'
        ];
        countElements.forEach(selector => {
            try {
                if ($w(selector)) {
                    $w(selector).text = count + ' Trails Available';
                }
            } catch(e) {
                console.warn('Trail count update failed for:', selector);
            }
        });
    };

    // ========================================
    // LIGHTBOX FUNCTIONS
    // ========================================
    
    window.showClubDetails = function(clubData) {
        try {
            if (!window.FitFriendsConfig.FEATURES.LIGHTBOXES) return;
            
            if ($w('#clubDetailsLightbox')) {
                // Populate club details
                const details = {
                    '#clubDetailsTitle': clubData.clubName || 'Unknown Club',
                    '#clubDetailsCategory': 'Category: ' + (clubData.clubCategory || 'General'),
                    '#clubDetailsEquipment': 'Equipment: ' + (clubData.equipmentType || 'Mixed'),
                    '#clubDetailsDescription': clubData.description || 'Premium fitness club with modern facilities'
                };
                
                Object.entries(details).forEach(([selector, text]) => {
                    try {
                        if ($w(selector)) $w(selector).text = text;
                    } catch(e) {}
                });
                
                $w('#clubDetailsLightbox').show();
                
                // Setup close handlers
                if ($w('#closeClubDetails')) {
                    $w('#closeClubDetails').onClick(() => $w('#clubDetailsLightbox').hide());
                }
                if ($w('#clubDetailsClose')) {
                    $w('#clubDetailsClose').onClick(() => $w('#clubDetailsLightbox').hide());
                }
            }
        } catch(e) {
            console.warn('Club details error:', e);
        }
    };

    window.showTrailDetails = function(trailData) {
        try {
            if (!window.FitFriendsConfig.FEATURES.LIGHTBOXES) return;
            
            if ($w('#trailDetailsLightbox')) {
                // Populate trail details
                const details = {
                    '#trailDetailsTitle': trailData.trailName || 'Unknown Trail',
                    '#trailDetailsLocation': 'Location: ' + (trailData.location || 'Unknown'),
                    '#trailDetailsDifficulty': 'Difficulty: ' + (trailData.difficulty || 'Moderate'),
                    '#trailDetailsDistance': 'Distance: ' + (trailData.distance || 'TBD'),
                    '#trailDetailsDescription': trailData.description || 'Scenic virtual trail experience'
                };
                
                Object.entries(details).forEach(([selector, text]) => {
                    try {
                        if ($w(selector)) $w(selector).text = text;
                    } catch(e) {}
                });
                
                $w('#trailDetailsLightbox').show();
                
                // Setup close handlers
                if ($w('#closeTrailDetails')) {
                    $w('#closeTrailDetails').onClick(() => $w('#trailDetailsLightbox').hide());
                }
                if ($w('#trailDetailsClose')) {
                    $w('#trailDetailsClose').onClick(() => $w('#trailDetailsLightbox').hide());
                }
            }
        } catch(e) {
            console.warn('Trail details error:', e);
        }
    };

    // ========================================
    // API CLASS
    // ========================================
    
    class FitFriendsAPI {
        constructor() {
            this.baseUrl = window.FitFriendsConfig.API_URL;
            this.timeout = window.FitFriendsConfig.TIMEOUT || 15000;
            this.retryAttempts = window.FitFriendsConfig.RETRY_ATTEMPTS || 3;
        }

        async apiCall(endpoint, options = {}, attempt = 1) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), this.timeout);
            
            try {
                if (window.FitFriendsConfig.DEBUG_MODE) {
                    console.log(`🔗 API Call (attempt ${attempt}): ${this.baseUrl}${endpoint}`);
                }
                
                const response = await fetch(`${this.baseUrl}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        ...options.headers
                    },
                    signal: controller.signal,
                    ...options
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (window.FitFriendsConfig.DEBUG_MODE) {
                    console.log(`✅ API Success: ${endpoint}`, result);
                }
                
                return result;
                
            } catch (error) {
                clearTimeout(timeoutId);
                
                console.error(`❌ API Error (attempt ${attempt}):`, error);
                
                // Retry logic
                if (attempt < this.retryAttempts && !error.name === 'AbortError') {
                    console.log(`🔄 Retrying API call... (${attempt + 1}/${this.retryAttempts})`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    return this.apiCall(endpoint, options, attempt + 1);
                }
                
                throw error;
            }
        }

        async healthCheck() { return await this.apiCall('/'); }
        async getFitnessClubs() { return await this.apiCall('/test/clubs'); }
        async getVirtualTrails() { return await this.apiCall('/test/trails'); }
        async runAllTests() { return await this.apiCall('/test/all'); }
    }

    // Initialize API
    let fitFriendsAPI;

    // ========================================
    // CORE FUNCTIONS
    // ========================================
    
    async function initializeFitFriendsClubs() {
        try {
            console.log('🚀 Initializing FitFriendsClubs...');
            
            if (!fitFriendsAPI) {
                fitFriendsAPI = new FitFriendsAPI();
            }
            
            showGlobalLoading();
            updateGlobalStatus('connecting', 'Connecting to API...');
            
            const healthCheck = await fitFriendsAPI.healthCheck();
            console.log('✅ API Health Check:', healthCheck);
            
            if (healthCheck.status === 'success') {
                updateGlobalStatus('online', 'API Connected ✅');
                showSuccess('FitFriendsClubs connected successfully!');
            } else {
                throw new Error('Health check failed');
            }
            
            hideGlobalLoading();
            return true;
            
        } catch (error) {
            console.error('❌ Initialization failed:', error);
            updateGlobalStatus('offline', 'API Connection Failed ❌');
            showError('Failed to connect to FitFriendsClubs API: ' + error.message);
            hideGlobalLoading();
            return false;
        }
    }

    function setupFitFriendsNavigation() {
        try {
            const navButtons = {
                '#homeButton': '/',
                '#clubsButton': '/clubs',
                '#trailsButton': '/trails',
                '#dashboardButton': '/dashboard',
                '#aboutButton': '/about',
                '#contactButton': '/contact'
            };
            
            Object.entries(navButtons).forEach(([selector, path]) => {
                try {
                    if ($w(selector)) {
                        $w(selector).onClick(() => {
                            console.log(`🧭 Navigating to: ${path}`);
                            wixLocation.to(path);
                        });
                    }
                } catch(e) {
                    console.warn(`Navigation button ${selector} not found`);
                }
            });
            
            // Test API button
            const testButtons = ['#testApiButton', '#runTestButton', '#apiTestButton'];
            testButtons.forEach(selector => {
                try {
                    if ($w(selector)) {
                        $w(selector).onClick(runAPITest);
                    }
                } catch(e) {}
            });
            
            console.log('🧭 Navigation setup complete');
            
        } catch (error) {
            console.error('❌ Navigation setup failed:', error);
        }
    }

    async function runAPITest() {
        try {
            console.log('🧪 Starting API test...');
            showLoading('#testResults');
            updateGlobalStatus('testing', 'Running API Tests...');
            
            const results = await fitFriendsAPI.runAllTests();
            
            // Update test results display
            const testElements = ['#testResults', '#apiTestResults', '#testOutput'];
            testElements.forEach(selector => {
                try {
                    if ($w(selector)) {
                        $w(selector).text = `✅ ${results.message || 'All tests passed!'}`;
                        $w(selector).style.color = '#4CAF50';
                    }
                } catch(e) {}
            });
            
            console.log('🧪 API Test Results:', results);
            showSuccess('API tests completed successfully!');
            updateGlobalStatus('online', 'API Tests Passed ✅');
            
            return results;
            
        } catch (error) {
            console.error('❌ API Test failed:', error);
            
            const testElements = ['#testResults', '#apiTestResults', '#testOutput'];
            testElements.forEach(selector => {
                try {
                    if ($w(selector)) {
                        $w(selector).text = `❌ Test Failed: ${error.message}`;
                        $w(selector).style.color = '#F44336';
                    }
                } catch(e) {}
            });
            
            showError('API test failed: ' + error.message);
            updateGlobalStatus('error', 'API Tests Failed ❌');
            
            return { status: 'error', message: error.message };
        } finally {
            hideLoading('#testResults');
        }
    }

    // ========================================
    // DATA LOADING FUNCTIONS
    // ========================================
    
    async function loadFitnessClubs() {
        if (!window.FitFriendsConfig.FEATURES.CLUBS) return;
        
        try {
            console.log('🏃‍♀️ Loading fitness clubs...');
            showLoading('#clubsContainer');
            
            const response = await fitFriendsAPI.getFitnessClubs();
            
            if (response.status === 'success' && response.data?.clubs) {
                displayFitnessClubs(response.data.clubs);
                updateClubCount(response.data.clubs.length);
                console.log(`✅ Loaded ${response.data.clubs.length} fitness clubs`);
            } else {
                throw new Error('Invalid clubs data received');
            }
            
        } catch (error) {
            console.error('❌ Failed to load clubs:', error);
            showError('Error loading fitness clubs: ' + error.message);
        } finally {
            hideLoading('#clubsContainer');
        }
    }

    async function loadVirtualTrails() {
        if (!window.FitFriendsConfig.FEATURES.TRAILS) return;
        
        try {
            console.log('🗺️ Loading virtual trails...');
            showLoading('#trailsContainer');
            
            const response = await fitFriendsAPI.getVirtualTrails();
            
            if (response.status === 'success' && response.data?.trails) {
                displayVirtualTrails(response.data.trails);
                updateTrailCount(response.data.trails.length);
                console.log(`✅ Loaded ${response.data.trails.length} virtual trails`);
            } else {
                throw new Error('Invalid trails data received');
            }
            
        } catch (error) {
            console.error('❌ Failed to load trails:', error);
            showError('Error loading virtual trails: ' + error.message);
        } finally {
            hideLoading('#trailsContainer');
        }
    }

    async function loadDashboardData() {
        if (!window.FitFriendsConfig.FEATURES.DASHBOARD) return;
        
        try {
            console.log('📊 Loading dashboard...');
            showLoading('#dashboardContainer');
            
            const testResults = await fitFriendsAPI.runAllTests();
            
            if ($w('#dashboardRepeater')) {
                displayDashboardData(testResults);
            }
            
            console.log('✅ Dashboard loaded');
            
        } catch (error) {
            console.error('❌ Failed to load dashboard:', error);
            showError('Failed to load dashboard data: ' + error.message);
        } finally {
            hideLoading('#dashboardContainer');
        }
    }

    // ========================================
    // DISPLAY FUNCTIONS
    // ========================================
    
    function displayFitnessClubs(clubs) {
        try {
            if (!$w('#clubsRepeater')) {
                console.warn('Clubs repeater element not found');
                return;
            }
            
            const clubData = clubs.map((club, index) => ({
                _id: club.id || `club-${index}`,
                clubName: club.name || 'Unknown Club',
                clubCategory: club.category || 'General Fitness',
                equipmentType: club.equipment_type || 'Mixed Equipment',
                description: club.description || 'Premium fitness club with modern facilities',
                location: club.location || 'Location TBD',
                memberCount: club.member_count || 0
            }));
            
            $w('#clubsRepeater').data = clubData;
            
            $w('#clubsRepeater').onItemReady(($item, itemData) => {
                try {
                    // Text elements
                    const textMappings = {
                        '#clubNameText': itemData.clubName,
                        '#clubCategoryText': itemData.clubCategory,
                        '#equipmentTypeText': `Equipment: ${itemData.equipmentType}`,
                        '#clubLocationText': itemData.location,
                        '#clubDescriptionText': itemData.description,
                        '#memberCountText': `${itemData.memberCount} members`
                    };
                    
                    Object.entries(textMappings).forEach(([selector, text]) => {
                        try {
                            if ($item(selector)) {
                                $item(selector).text = text;
                            }
                        } catch(e) {}
                    });
                    
                    // Click handlers
                    const clickableElements = ['#clubContainer', '#clubCard', '#clubItem'];
                    clickableElements.forEach(selector => {
                        try {
                            if ($item(selector)) {
                                $item(selector).onClick(() => showClubDetails(itemData));
                                $item(selector).style.cursor = 'pointer';
                            }
                        } catch(e) {}
                    });
                    
                } catch(e) {
                    console.warn('Club item setup failed:', e);
                }
            });
            
            console.log(`✅ Displayed ${clubs.length} fitness clubs`);
            
        } catch (error) {
            console.error('❌ Display clubs failed:', error);
        }
    }

    function displayVirtualTrails(trails) {
        try {
            if (!$w('#trailsRepeater')) {
                console.warn('Trails repeater element not found');
                return;
            }
            
            const trailData = trails.map((trail, index) => ({
                _id: trail.id || `trail-${index}`,
                trailName: trail.name || 'Unknown Trail',
                location: trail.location || 'Unknown Location',
                difficulty: trail.difficulty || 'Moderate',
                distance: trail.distance_km ? `${trail.distance_km}km` : 'Distance TBD',
                description: trail.description || 'Scenic virtual trail experience',
                estimatedTime: trail.estimated_time || '30-60 min',
                elevation: trail.elevation_gain || 'Moderate'
            }));
            
            $w('#trailsRepeater').data = trailData;
            
            $w('#trailsRepeater').onItemReady(($item, itemData) => {
                try {
                    // Text elements
                    const textMappings = {
                        '#trailNameText': itemData.trailName,
                        '#locationText': itemData.location,
                        '#difficultyText': `Difficulty: ${itemData.difficulty}`,
                        '#distanceText': itemData.distance,
                        '#trailDescriptionText': itemData.description,
                        '#estimatedTimeText': `Est. Time: ${itemData.estimatedTime}`,
                        '#elevationText': `Elevation: ${itemData.elevation}`
                    };
                    
                    Object.entries(textMappings).forEach(([selector, text]) => {
                        try {
                            if ($item(selector)) {
                                $item(selector).text = text;
                            }
                        } catch(e) {}
                    });
                    
                    // Difficulty badge styling
                    try {
                        if ($item('#difficultyBadge')) {
                            const difficultyClass = `fitfriends-difficulty-${itemData.difficulty.toLowerCase()}`;
                            $item('#difficultyBadge').addClass(difficultyClass);
                            $item('#difficultyBadge').text = itemData.difficulty;
                        }
                    } catch(e) {}
                    
                    // Click handlers
                    const clickableElements = ['#trailContainer', '#trailCard', '#trailItem'];
                    clickableElements.forEach(selector => {
                        try {
                            if ($item(selector)) {
                                $item(selector).onClick(() => showTrailDetails(itemData));
                                $item(selector).style.cursor = 'pointer';
                            }
                        } catch(e) {}
                    });
                    
                } catch(e) {
                    console.warn('Trail item setup failed:', e);
                }
            });
            
            console.log(`✅ Displayed ${trails.length} virtual trails`);
            
        } catch (error) {
            console.error('❌ Display trails failed:', error);
        }
    }

    function displayDashboardData(testResults) {
        try {
            if (!$w('#dashboardRepeater')) {
                console.warn('Dashboard repeater element not found');
                return;
            }
            
            const dashboardItems = testResults.results.map((test, index) => ({
                _id: `test-${index}`,
                testName: test.name,
                status: test.status,
                message: test.message,
                responseTime: test.responseTime || 'N/A',
                dataCount: test.dataCount || 0,
                timestamp: new Date().toLocaleTimeString()
            }));
            
            $w('#dashboardRepeater').data = dashboardItems;
            
            $w('#dashboardRepeater').onItemReady(($item, itemData) => {
                try {
                    // Text elements
                    const textMappings = {
                        '#testNameText': itemData.testName,
                        '#messageText': itemData.message,
                        '#responseTimeText': `${itemData.responseTime}ms`,
                        '#dataCountText': `${itemData.dataCount} items`,
                        '#timestampText': itemData.timestamp
                    };
                    
                    Object.entries(textMappings).forEach(([selector, text]) => {
                        try {
                            if ($item(selector)) {
                                $item(selector).text = text;
                            }
                        } catch(e) {}
                    });
                    
                    // Status with color coding
                    try {
                        if ($item('#statusText')) {
                            $item('#statusText').text = itemData.status.toUpperCase();
                            
                            const statusColors = {
                                'success': '#4CAF50',
                                'error': '#F44336',
                                'warning': '#FF9800',
                                'info': '#2196F3'
                            };
                            
                            const color = statusColors[itemData.status] || '#757575';
                            $item('#statusText').style.color = color;
                        }
                    } catch(e) {}
                    
                } catch(e) {
                    console.warn('Dashboard item setup failed:', e);
                }
            });
            
            console.log(`✅ Dashboard loaded with ${dashboardItems.length} items`);
            
        } catch (error) {
            console.error('❌ Display dashboard failed:', error);
        }
    }

    // ========================================
    // PAGE LOADING LOGIC
    // ========================================
    
    function loadPageData() {
        try {
            const currentPage = wixLocation.path || '/';
            console.log(`📄 Loading data for page: ${currentPage}`);
            
            // Page-specific loaders
            switch (currentPage) {
                case '/clubs':
                    loadFitnessClubs();
                    break;
                case '/trails':
                    loadVirtualTrails();
                    break;
                case '/dashboard':
                    loadDashboardData();
                    break;
                case '/':
                case '':
                    loadHomepageStats();
                    break;
                default:
                    console.log('No specific loader for this page');
                    break;
            }
            
        } catch (error) {
            console.error('❌ Load page data failed:', error);
        }
    }

    async function loadHomepageStats() {
        try {
            console.log('🏠 Loading homepage statistics...');
            
            const testResults = await fitFriendsAPI.runAllTests();
            
            if (testResults.status === 'success') {
                // Extract data from test results
                const clubsTest = testResults.results.find(test => 
                    test.name.toLowerCase().includes('club')
                );
                const trailsTest = testResults.results.find(test => 
                    test.name.toLowerCase().includes('trail')
                );
                
                // Update homepage stats
                const statsUpdates = {
                    '#clubCountText': clubsTest ? `${clubsTest.dataCount} Premium Clubs` : '6 Premium Clubs',
                    '#trailCountText': trailsTest ? `${trailsTest.dataCount} Virtual Trails` : '8 Virtual Trails',
                    '#platformStatusText': 'All Systems Operational ✅',
                    '#totalMembersText': '1,250+ Members',
                    '#activeSessionsText': '45 Active Sessions'
                };
                
                Object.entries(statsUpdates).forEach(([selector, text]) => {
                    try {
                        if ($w(selector)) {
                            $w(selector).text = text;
                        }
                    } catch(e) {}
                });
                
                console.log('✅ Homepage stats updated');
            }
            
        } catch (error) {
            console.error('❌ Failed to load homepage stats:', error);
        }
    }

    // ========================================
    // DEBUG AND TESTING
    // ========================================
    
    window.testFitFriendsAPI = async function() {
        console.log('🧪 Manual API test triggered...');
        return await runAPITest();
    };

    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', function(event) {
            try {
                // Escape key closes lightboxes
                if (event.key === 'Escape') {
                    ['#clubDetailsLightbox', '#trailDetailsLightbox'].forEach(selector => {
                        try {
                            if ($w(selector)) $w(selector).hide();
                        } catch(e) {}
                    });
                }
                
                // Ctrl/Cmd + T for API test (debug mode only)
                if ((event.ctrlKey || event.metaKey) && event.key === 't' && window.FitFriendsConfig.DEBUG_MODE) {
                    event.preventDefault();
                    testFitFriendsAPI();
                }
                
                // Ctrl/Cmd + D for debug info
                if ((event.ctrlKey || event.metaKey) && event.key === 'd' && window.FitFriendsConfig.DEBUG_MODE) {
                    event.preventDefault();
                    console.log('🔧 FitFriends Debug Info:', {
                        config: window.FitFriendsConfig,
                        api: fitFriendsAPI,
                        page: wixLocation.path,
                        timestamp: new Date().toISOString()
                    });
                }
                
            } catch(e) {
                console.warn('Keyboard shortcut error:', e);
            }
        });
    }

    function setupDebugPanel() {
        if (!window.FitFriendsConfig.DEBUG_MODE || !window.FitFriendsConfig.FEATURES.DEBUG_PANEL) {
            return;
        }
        
        try {
            // Create debug panel if not exists
            if (!document.getElementById('fitfriendsDebugPanel')) {
                const debugPanel = document.createElement('div');
                debugPanel.id = 'fitfriendsDebugPanel';
                debugPanel.className = 'fitfriends-debug';
                debugPanel.innerHTML = `
                    <div><strong>FitFriends Debug</strong></div>
                    <div>API: <span id="debugApiStatus">Checking...</span></div>
                    <div>Page: <span id="debugCurrentPage">${wixLocation.path || '/'}</span></div>
                    <div>Time: <span id="debugTimestamp">${new Date().toLocaleTimeString()}</span></div>
                    <button onclick="testFitFriendsAPI()">Test API</button>
                    <button onclick="console.log('FitFriends:', window.FitFriendsClubs)">Log Debug</button>
                `;
                document.body.appendChild(debugPanel);
                
                // Update debug info periodically
                setInterval(() => {
                    try {
                        const timestampEl = document.getElementById('debugTimestamp');
                        if (timestampEl) {
                            timestampEl.textContent = new Date().toLocaleTimeString();
                        }
                    } catch(e) {}
                }, 30000);
            }
        } catch(e) {
            console.warn('Debug panel setup failed:', e);
        }
    }

    // ========================================
    // MAIN INITIALIZATION
    // ========================================
    
    function initializeWixIntegration() {
        if (typeof $w === 'undefined') {
            console.warn('⚠️ Wix $w not available, deferring initialization...');
            setTimeout(initializeWixIntegration, 2000);
            return;
        }
        
        $w.onReady(async function () {
            try {
                console.log('✅ FitFriendsClubs Wix page ready!');
                
                // Initialize the application
                const initialized = await initializeFitFriendsClubs();
                
                if (initialized) {
                    // Setup all components
                    setupFitFriendsNavigation();
                    setupKeyboardShortcuts();
                    setupDebugPanel();
                    
                    // Load page-specific data
                    if (window.FitFriendsConfig.AUTO_LOAD) {
                        setTimeout(loadPageData, 1000);
                    }
                    
                    // Export debug interface
                    if (window.FitFriendsConfig.DEBUG_MODE) {
                        window.FitFriendsClubs = {
                            api: fitFriendsAPI,
                            config: window.FitFriendsConfig,
                            functions: {
                                loadClubs: loadFitnessClubs,
                                loadTrails: loadVirtualTrails,
                                loadDashboard: loadDashboardData,
                                test: runAPITest,
                                showClubDetails,
                                showTrailDetails
                            },
                            utils: {
                                showLoading,
                                hideLoading,
                                showError,
                                showSuccess,
                                updateGlobalStatus
                            }
                        };
                        
                        console.log('🔧 Debug interface available at window.FitFriendsClubs');
                    }
                    
                    console.log('🎉 FitFriendsClubs initialization complete!');
                }
                
            } catch (error) {
                console.error('❌ FitFriendsClubs initialization error:', error);
                updateGlobalStatus('error', 'Initialization Failed ❌');
                showError('FitFriendsClubs failed to initialize: ' + error.message);
            }
        });
    }

    // Error boundary
    window.addEventListener('error', function(event) {
        if (event.error && event.error.message && event.error.message.includes('FitFriends')) {
            console.error('❌ FitFriends Global Error:', event.error);
            if (window.FitFriendsConfig && window.FitFriendsConfig.DEBUG_MODE) {
                showError('FitFriends Error: ' + event.error.message);
            }
        }
    });

    // Start initialization
    initializeWixIntegration();
    
    console.log('✅ FitFriendsClubs Complete Integration Loaded Successfully!');

})();
</script>

<!-- Hidden Elements for Loading and Messages -->
<div id="globalLoading" style="display: none;" class="fitfriends-loading-overlay">
    <div>
        <div class="fitfriends-loading"></div>
        <p style="margin-top: 15px; font-weight: bold; color: #333;">Loading FitFriendsClubs...</p>
    </div>
</div>

<div id="globalMessages" style="position: fixed; top: 20px; right: 20px; z-index: 9998; max-width: 350px;">
    <div id="errorMessage" style="display: none;"></div>
    <div id="successMessage" style="display: none;"></div>
</div>

<div id="loadingIcon" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
    <div class="fitfriends-loading"></div>
</div>